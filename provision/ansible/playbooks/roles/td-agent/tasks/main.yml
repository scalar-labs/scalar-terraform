---
# tasks file for ansible-role-td-agent
- import_tasks: setup-redhat.yml
  when: ansible_os_family == 'RedHat'

- import_tasks: setup-debian.yml
  when: ansible_os_family == 'Debian'

- name: Install td-agent
  package:
    name: td-agent
    state: present

- name: Install td-agent plugins
  gem:
    name: "{{ item.name }}"
    version: "{{ item.version }}"
    executable: /usr/sbin/td-agent-gem
    user_install: no
    state: present
  loop: "{{ td_agent_plugins }}"

- name: Create conf.d directory
  file:
    path: /etc/td-agent/conf.d
    state: directory

- name: Enable td-agent
  systemd:
    name: td-agent
    enabled: yes

- name: Update rsyslog.conf to forward logs
  lineinfile:
    path: /etc/rsyslog.conf
    line: "*.* @127.0.0.1:5140"
  notify:
    - restart rsyslog

- name: Update td-agent.conf
  template:
    src: td-agent.conf.j2
    dest: /etc/td-agent/td-agent.conf
    owner: td-agent
    group: td-agent
  notify:
    - reload td-agent

- name: Add user defined templates
  template:
    src: "{{ item.src }}"
    dest: "{{ tdagent_confd_dir }}/{{ item.dest }}"
    owner: td-agent
    group: td-agent
  loop: "{{ tdagent_confd_templates }}"
  when: tdagent_confd_templates is defined
  notify:
    - reload td-agent

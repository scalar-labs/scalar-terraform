---
- import_tasks: setup-redhat.yml
  when: ansible_os_family == 'RedHat'

- import_tasks: setup-debian.yml
  when: ansible_os_family == 'Debian'

- set_fact:
    ansible_python_default_interpreter: "{{ ansible_python_interpreter }}"
    ansible_python_interpreter: /usr/bin/python3

- name: Upgrade pip
  pip:
    name: pip
    executable: pip3
    state: latest

- name: Install required packages via pip
  pip:
    name: "{{ item }}"
    state: present
    executable: pip3
  loop: "{{ pip_packages }}"

- set_fact:
    ansible_python_interpreter: "{{ ansible_python_default_interpreter }}"

- name: Install required packages
  package:
    name: "{{ required_packages }}"
    state: present
  retries: 3
  delay: 5

- name: Install Prometheus Node Exporter
  block:
    - get_url:
        url: https://github.com/prometheus/node_exporter/releases/download/v0.16.0/node_exporter-0.16.0.linux-amd64.tar.gz
        dest: /tmp
    - file:
        path: "/etc/prometheus/node_exporter"
        state: directory
        mode: 0755
    - unarchive:
        src: /tmp/{{ NODE_EXPORTER_FILE | default('node_exporter-0.16.0.linux-amd64.tar.gz') }}
        dest: "/etc/prometheus/node_exporter"
        remote_src: yes
        extra_opts:
          - --strip-components=1
    - file:
        state: absent
        path: /tmp/{{ NODE_EXPORTER_FILE | default('node_exporter-0.16.0.linux-amd64.tar.gz') }}
    - copy:
        src: node_exporter.service
        dest: /etc/systemd/system/node_exporter.service
    - systemd:
        name: node_exporter
        enabled: yes
        daemon_reload: yes
        state: started
